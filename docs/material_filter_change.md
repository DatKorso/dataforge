# Изменения в алгоритме "Объединить по похожим WB товарам"

**Дата:** 1 октября 2025 г.
**Задача:** Добавить обязательное требование на точное совпадение `material_short`

## Проблема

Ранее алгоритм схожести учитывал `material_short` только как один из факторов, влияющих на вес совпадения (давал бонус +30 к score). Это приводило к тому, что товары с разными материалами могли попадать в одну группу объединения.

## Решение

Добавлен жёсткий фильтр на уровне SQL-запроса в CTE `pairs`:

```sql
WHERE (pg_seed.material_short IS NULL 
       OR pg_cand.material_short IS NULL 
       OR pg_seed.material_short = pg_cand.material_short)
```

### Логика фильтра:

1. **Если у товара-образца нет `material_short`** (`NULL`) → кандидат проходит фильтр
2. **Если у кандидата нет `material_short`** (`NULL`) → кандидат проходит фильтр  
3. **Если оба значения заполнены** → они **должны точно совпадать**, иначе кандидат исключается

### Технические детали:

- **Файл:** `dataforge/similarity_matching.py`
- **Функции:** 
  - `search_similar_matches()` - основной алгоритм
  - `search_similar_matches_debug()` - debug-вариант со статистикой
- **Переменная:** `material_filter` (строка SQL WHERE-условия)
- **Применение:** в CTE `pairs` после JOIN с `punta_google`

## Эффект

- **Уменьшение пула кандидатов**: только товары с совпадающим `material_short` (или NULL)
- **Более точные группы**: товары объединяются только если материал совпадает
- **Сохранение гибкости**: если `material_short` не заполнен, фильтр не блокирует товар

## Пример

**До изменений:**
- Товар A (кожа) + Товар B (замша) → могли попасть в одну группу, если другие параметры совпадали

**После изменений:**
- Товар A (кожа) + Товар B (замша) → **НЕ** попадут в одну группу (material_short не совпадает)
- Товар A (кожа) + Товар C (кожа) → попадут в одну группу (material_short совпадает)
- Товар A (кожа) + Товар D (NULL) → попадут в одну группу (у D нет material_short)

## Тестирование

Создан unit-тест `test_material_filter_unit.py`, проверяющий:
- ✅ Наличие переменной `material_filter`
- ✅ Корректность SQL-условия фильтрации
- ✅ Применение фильтра в CTE `pairs`
- ✅ Наличие фильтра в debug-функции

**Результат:** Все проверки прошли успешно ✅

## Обратная совместимость

Изменения **не нарушают** обратную совместимость:
- Если `punta_google` таблица отсутствует → фильтр не применяется (как и раньше)
- Если `material_short` не заполнен → товары обрабатываются как раньше
- Existing merge_codes и group_numbers сохраняют свою логику

## Связанные файлы

- `dataforge/similarity_matching.py` - основной код алгоритма
- `test_material_filter_unit.py` - unit-тест генерации SQL
- `test_material_filter.py` - интеграционный тест (требует БД)
