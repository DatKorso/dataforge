# ТЗ: Импорт товаров Ozon

## 1. Описание источника данных
Список файлов загружаемых пользователем за одновременно. Данные из документов загружаются в бд.
**Формат файла:** .xlsx, .xls
**Структура листов:**
- `Шаблон` - основные данные товаров (70 колонок A-BT)
- `Озон.Видео` - видеоматериалы товаров (4 колонки A-D)
- `Озон.Видеообложка` - обложки видео товаров (2 колонки A-B)
**Расположение данных:**
- Заголовки: строка 2
- Данные: начиная со строки 5
**Наличие заголовков:** Да, в строке 2 каждого листа
**Название таблицы в БД** oz_products_full

## 2. Маппинг данных

### Лист "Шаблон"

| Название колонки | Название в БД | Тип данных | Обязательность |
|------------------|---------------|------------|----------------|
| Артикул* | oz_vendor_code | VARCHAR(100) | Обязательно |
| Название товара | product_name | VARCHAR(500) | Необязательно |
| Цена, руб.* | price | DECIMAL(10,2) | Необязательно |
| Цена до скидки, руб. | price_before_discount | DECIMAL(10,2) | Необязательно |
| НДС, %* | vat_percent | INTEGER | Необязательно |
| Штрихкод (Серийный номер / EAN) | barcodes | TEXT | Необязательно |
| Вес в упаковке, г* | weight_grams | INTEGER | Необязательно |
| Ширина упаковки, мм* | package_width_mm | INTEGER | Необязательно |
| Высота упаковки, мм* | package_height_mm | INTEGER | Необязательно |
| Длина упаковки, мм* | package_length_mm | INTEGER | Необязательно |
| Ссылка на главное фото* | main_photo_url | TEXT | Необязательно |
| Ссылки на дополнительные фото | additional_photos_urls | TEXT | Необязательно |
| Артикул фото | photo_article | VARCHAR(100) | Необязательно |
| Бренд в одежде и обуви* | brand | VARCHAR(100) | Необязательно |
| Объединить на одной карточке* | group_on_card | VARCHAR(100) | Необязательно |
| Цвет товара* | color | VARCHAR(100) | Необязательно |
| Российский размер* | russian_size | VARCHAR(20) | Необязательно |
| Название цвета | color_name | VARCHAR(100) | Необязательно |
| Размер производителя | manufacturer_size | VARCHAR(20) | Необязательно |
| Тип* | product_type | VARCHAR(100) | Необязательно |
| Пол* | gender | VARCHAR(20) | Необязательно |
| Сезон | season | VARCHAR(50) | Необязательно |
| Название группы | group_name | VARCHAR(200) | Необязательно |
| Ошибка | error_message | TEXT | Необязательно |
| Предупреждение | warning_message | TEXT | Необязательно |

### Лист "Озон.Видео"

| Название колонки | Название в БД | Тип данных | Обязательность |
|------------------|---------------|------------|----------------|
| Артикул* | oz_article | VARCHAR(100) | Обязательно |
| Озон.Видео: название | video_name | VARCHAR(500) | Необязательно |
| Озон.Видео: ссылка | video_url | TEXT | Необязательно |
| Озон.Видео: товары на видео | video_products | TEXT | Необязательно |

### Лист "Озон.Видеообложка"

| Название колонки | Название в БД | Тип данных | Обязательность |
|------------------|---------------|------------|----------------|
| Артикул* | oz_article | VARCHAR(100) | Обязательно |
| Озон.Видеообложка: ссылка | video_cover_url | TEXT | Необязательно |

## 3. Правила валидации

**Форматы данных:**
- **barcodes**: Список баркодов через ';'

**Уникальность:**
- Артикул должен быть уникальным
- **Основной баркод** (последний в списке): должен быть уникальным в рамках загрузки

**Обязательные поля:**
- Артикул* - основной ключ для объединения данных

## 4. Обработка ошибок

**Дублирующиеся записи:**
- Для избежания дубликатов, нужно каждый новый отчет перезаписывать таблицу

**Некорректные данные:**
- Пропустить строку с ошибкой валидации
- Записать детали ошибки в лог с указанием номера строки и файла
- Продолжить обработку остальных записей

**Логирование ошибок:**
- Обязательно логировать все ошибки валидации
- Создавать отчет об ошибках после завершения импорта
- Сохранять статистику: всего строк, успешно обработано, с ошибками

**Стратегия:** Пропустить строку с ошибкой, продолжить обработку

## 5. Дополнительные требования

**Преобразования данных:**
- **barcodes**: Разделить строку по ';' и сохранить как JSON массив
- **primary_barcode**: Извлечь последний баркод из списка как основной (актуальный для Ozon)

**Вычисляемые поля:**
- `import_date` - дата и время импорта (TIMESTAMP)
- `primary_barcode` - последний баркод из списка barcodes (VARCHAR(50))

**Производительность:**
- Использование транзакций для обеспечения целостности данных
- Создание индексов по полям: `oz_vendor_code`, `barcode-primary`
- Оптимизация запросов объединения данных из трех листов

**Объединение данных:**
- Основная таблица формируется из листа "Шаблон"
- Данные из листов "Озон.Видео" и "Озон.Видеообложка" присоединяются по полю `oz_vendor_code` (LEFT JOIN)
- Если в дополнительных листах нет данных для артикула - поля остаются NULL
- Обработка множественных файлов: данные объединяются в единую таблицу с сохранением информации об источнике

**Мониторинг:**
- Отслеживание времени выполнения импорта
- Контроль использования памяти при обработке больших файлов
- Уведомления о завершении импорта с статистикой
