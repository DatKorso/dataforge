# –ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ —Ä–∞–∑–º–µ—Ä–æ–≤

## –û–ø–∏—Å–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏

–î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã —Ä–∞–∑–º–µ—Ä–æ–≤ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö —Å–∫–ª–µ–π–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤, –ø–æ–º–µ—á–∞—è –∏—Ö —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–º –ø—Ä–µ—Ñ–∏–∫—Å–æ–º –≤ `merge_code`.

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### Checkbox "–ë–µ–∑ –¥—É–±–ª–µ–π —Ä–∞–∑–º–µ—Ä–æ–≤"

#### ‚úÖ –ö–æ–≥–¥–∞ –≤–∫–ª—é—á–µ–Ω (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
- –î—É–±–ª–∏–∫–∞—Ç—ã —Ä–∞–∑–º–µ—Ä–æ–≤ –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª—è—é—Ç—Å—è
- –û—Å—Ç–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ç–æ–≤–∞—Ä —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º `match_score` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
- –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ, –∫–∞–∫ —Ä–∞–Ω—å—à–µ

#### ‚ùå –ö–æ–≥–¥–∞ –≤—ã–∫–ª—é—á–µ–Ω (–Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å)
- –î—É–±–ª–∏–∫–∞—Ç—ã —Ä–∞–∑–º–µ—Ä–æ–≤ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö
- –õ—É—á—à–∏–π —Ç–æ–≤–∞—Ä (—Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º `match_score`) –ø–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø—Ä–µ—Ñ–∏–∫—Å
- –î—É–±–ª–∏–∫–∞—Ç—ã –ø–æ–ª—É—á–∞—é—Ç –ø—Ä–µ—Ñ–∏–∫—Å `D` –≤–º–µ—Å—Ç–æ `C` –∏–ª–∏ `B`
- –ü—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è —Å—É—Ñ—Ñ–∏–∫—Å `_N`

## –§–æ—Ä–º–∞—Ç merge_code

### –ê–ª–≥–æ—Ä–∏—Ç–º "–û–±—ä–µ–¥–∏–Ω–∏—Ç—å –ø–æ –ø–æ—Ö–æ–∂–∏–º WB —Ç–æ–≤–∞—Ä–∞–º" (wb_similarity)

**–û—Å–Ω–æ–≤–Ω–æ–π —Ç–æ–≤–∞—Ä:**
```
C-{color}-{hex}
–ü—Ä–∏–º–µ—Ä: C-–ß—ë—Ä–Ω—ã–π-A0F23B
```

**–î—É–±–ª–∏–∫–∞—Ç (–æ–¥–∏–Ω):**
```
D-{color}-{hex}
–ü—Ä–∏–º–µ—Ä: D-–ß—ë—Ä–Ω—ã–π-A0F23B
```

**–î—É–±–ª–∏–∫–∞—Ç—ã (–Ω–µ—Å–∫–æ–ª—å–∫–æ):**
```
D-{color}-{hex}_2
D-{color}-{hex}_3
D-{color}-{hex}_4
...
–ü—Ä–∏–º–µ—Ä: D-–ß—ë—Ä–Ω—ã–π-A0F23B_2, D-–ß—ë—Ä–Ω—ã–π-A0F23B_3
```

### –ê–ª–≥–æ—Ä–∏—Ç–º "–û–±—ä–µ–¥–∏–Ω–∏—Ç—å –ø–æ –æ–±—â–µ–º—É WB –∞—Ä—Ç–∏–∫—É–ª—É" (wb_by_sku)

**–û—Å–Ω–æ–≤–Ω–æ–π —Ç–æ–≤–∞—Ä:**
```
B-{hex}
–ü—Ä–∏–º–µ—Ä: B-A0F23B
```

**–î—É–±–ª–∏–∫–∞—Ç (–æ–¥–∏–Ω):**
```
D-{hex}
–ü—Ä–∏–º–µ—Ä: D-A0F23B
```

**–î—É–±–ª–∏–∫–∞—Ç—ã (–Ω–µ—Å–∫–æ–ª—å–∫–æ):**
```
D-{hex}_2
D-{hex}_3
...
–ü—Ä–∏–º–µ—Ä: D-A0F23B_2, D-A0F23B_3
```

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü—Ä–∏–º–µ—Ä 1: –û–¥–∏–Ω –¥—É–±–ª–∏–∫–∞—Ç
```
–¢–æ–≤–∞—Ä—ã —Å —Ä–∞–∑–º–µ—Ä–æ–º 30 –≤ –≥—Ä—É–ø–ø–µ 1:
1. oz_sku=1086155456, match_score=95 ‚Üí merge_code: C-–ß—ë—Ä–Ω—ã–π-A0F23B, group_number: 1
2. oz_sku=2143079762, match_score=85 ‚Üí merge_code: D-–ß—ë—Ä–Ω—ã–π-A0F23B, group_number: 101 (–Ω–æ–≤–∞—è –≥—Ä—É–ø–ø–∞)
```

### –ü—Ä–∏–º–µ—Ä 2: –ù–µ—Å–∫–æ–ª—å–∫–æ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
```
–¢–æ–≤–∞—Ä—ã —Å —Ä–∞–∑–º–µ—Ä–æ–º 30 –≤ –≥—Ä—É–ø–ø–µ 1:
1. oz_sku=111, match_score=100 ‚Üí merge_code: C-–ö—Ä–∞—Å–Ω—ã–π-FFAA00, group_number: 1
2. oz_sku=222, match_score=90  ‚Üí merge_code: D-–ö—Ä–∞—Å–Ω—ã–π-FFAA00_2, group_number: 101
3. oz_sku=333, match_score=80  ‚Üí merge_code: D-–ö—Ä–∞—Å–Ω—ã–π-FFAA00_3, group_number: 102
4. oz_sku=444, match_score=70  ‚Üí merge_code: D-–ö—Ä–∞—Å–Ω—ã–π-FFAA00_4, group_number: 103
```

### –ü—Ä–∏–º–µ—Ä 3: –†–∞–∑–Ω—ã–µ –≥—Ä—É–ø–ø—ã
```
–ì—Ä—É–ø–ø–∞ 1, —Ä–∞–∑–º–µ—Ä 30:
- oz_sku=111, match_score=100 ‚Üí C-–ß—ë—Ä–Ω—ã–π-A0F23B (group_number: 1)
- oz_sku=222, match_score=90  ‚Üí D-–ß—ë—Ä–Ω—ã–π-A0F23B (group_number: 101)

–ì—Ä—É–ø–ø–∞ 2, —Ä–∞–∑–º–µ—Ä 30 (–¥—Ä—É–≥–æ–π wb_sku):
- oz_sku=333, match_score=95  ‚Üí C-–°–∏–Ω–∏–π-B1F34C (group_number: 2)
- oz_sku=444, match_score=85  ‚Üí D-–°–∏–Ω–∏–π-B1F34C (group_number: 102)
```

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

1. **–°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö** - –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ–ª—É—á–∞—é—Ç —Ç–µ –∂–µ –ø–æ–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∞—Ü–∏–∏, —á—Ç–æ –∏ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã
2. **–û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º–æ—Å—Ç—å** - –ª–µ–≥–∫–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ –ø—Ä–µ—Ñ–∏–∫—Å—É `D`
3. **–ò–∑–æ–ª—è—Ü–∏—è –Ω–∞ –û–∑–æ–Ω** - —Ä–∞–∑–Ω—ã–µ –≥—Ä—É–ø–ø—ã (–∏–∑-–∑–∞ —Ä–∞–∑–Ω—ã—Ö merge_code) –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ
4. **–ì–∏–±–∫–æ—Å—Ç—å** - –º–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∑–∞–¥–∞—á–∏

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –§—É–Ω–∫—Ü–∏—è `mark_duplicate_sizes`

–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ: `dataforge/matching_helpers.py`

```python
def mark_duplicate_sizes(
    df,
    primary_prefix: str = "C",
    duplicate_prefix: str = "D",
):
    """Mark duplicate sizes within groups by modifying merge_code."""
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `df` - DataFrame —Å –∫–æ–ª–æ–Ω–∫–∞–º–∏: `group_number`, `oz_manufacturer_size`, `merge_code`, `match_score`
- `primary_prefix` - –ø—Ä–µ—Ñ–∏–∫—Å –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `"C"`)
- `duplicate_prefix` - –ø—Ä–µ—Ñ–∏–∫—Å –¥–ª—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `"D"`)

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
- DataFrame —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–º–∏ `merge_code` –∏ `group_number` –¥–ª—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

### –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

1. –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ `group_number`, `oz_manufacturer_size`, `match_score` (—É–±—ã–≤–∞–Ω–∏–µ)
2. –î–ª—è –∫–∞–∂–¥–æ–π –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ `group_number` + `oz_manufacturer_size`:
   - –ü–µ—Ä–≤—ã–π —Ç–æ–≤–∞—Ä (–ª—É—á—à–∏–π score) ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –ø—Ä–µ—Ñ–∏–∫—Å –∏ group_number
   - –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã ‚Üí –ø–æ–ª—É—á–∞—é—Ç –ø—Ä–µ—Ñ–∏–∫—Å `D` –∏ –Ω–æ–≤—ã–π group_number
   - –ü—Ä–∏ >2 —Ç–æ–≤–∞—Ä–∞—Ö –æ–¥–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ ‚Üí –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è —Å—É—Ñ—Ñ–∏–∫—Å `_N`

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–¢–µ—Å—Ç—ã –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ `tests/test_matching_helpers.py`:

- `test_mark_duplicate_sizes_basic` - –±–∞–∑–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
- `test_mark_duplicate_sizes_multiple_duplicates` - –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –¥—É–±–ª–∏–∫–∞—Ç—ã —Å —Å—É—Ñ—Ñ–∏–∫—Å–∞–º–∏
- `test_mark_duplicate_sizes_multiple_groups` - —Ä–∞–±–æ—Ç–∞ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –≥—Ä—É–ø–ø–∞–º–∏

–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤:
```bash
uv run pytest tests/test_matching_helpers.py::test_mark_duplicate_sizes_basic -v
```

## –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

**2 –æ–∫—Ç—è–±—Ä—è 2025 (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ #2)**
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Å –ø–µ—Ä–µ—Å—á—ë—Ç–æ–º `group_number` –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö –ø–∞—Ä—Ç–∏—è–º–∏ (chunks)
- –î–æ–±–∞–≤–ª–µ–Ω –ø–µ—Ä–µ—Å—á—ë—Ç `group_number` –Ω–∞ –æ—Å–Ω–æ–≤–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö `merge_code` –ø–µ—Ä–µ–¥ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–æ–π –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
- –î–æ–±–∞–≤–ª–µ–Ω —Ç–µ—Å—Ç `test_group_number_recalculation_before_marking`

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö –ø–∞—Ä—Ç–∏—è–º–∏ –∫–∞–∂–¥—ã–π —á–∞–Ω–∫ –ø–æ–ª—É—á–∞–ª —Å–≤–æ—é –Ω—É–º–µ—Ä–∞—Ü–∏—é –≥—Ä—É–ø–ø (–Ω–∞—á–∏–Ω–∞—è —Å 1). –ü–æ—Å–ª–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è —á–∞–Ω–∫–æ–≤ —Ä–∞–∑–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã –º–æ–≥–ª–∏ –∏–º–µ—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π `group_number`, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –º–∞—Ä–∫–∏—Ä–æ–≤–∫–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤.

**–†–µ—à–µ–Ω–∏–µ:** –ü–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º `mark_duplicate_sizes` –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º `group_number` –Ω–∞ –æ—Å–Ω–æ–≤–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π `merge_code` –¥–ª—è –≤—Å–µ–≥–æ –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω–æ–≥–æ –¥–∞—Ç–∞—Å–µ—Ç–∞.

**2 –æ–∫—Ç—è–±—Ä—è 2025 (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ #1)**
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Å –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å—é `merge_code` —Ñ—É–Ω–∫—Ü–∏–µ–π `add_merge_fields` –ø–æ—Å–ª–µ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
- –í—ã–∑–æ–≤ `add_merge_fields` —Ç–µ–ø–µ—Ä—å –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏, –Ω–æ –Ω–µ –ø–æ—Å–ª–µ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏

**2 –æ–∫—Ç—è–±—Ä—è 2025**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `mark_duplicate_sizes`
- –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `add_merge_fields_with_duplicates` (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥)
- –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –≤ —Å—Ç—Ä–∞–Ω–∏—Ü—É "08_üß©_–°–∫–ª–µ–π–∫–∞_OZ.py"
- –î–æ–±–∞–≤–ª–µ–Ω—ã —é–Ω–∏—Ç-—Ç–µ—Å—Ç—ã
