# ТЗ: Импорт товаров WB (wb_products)

## 1. Описание источника данных

**Формат файла:** .xlsx, .xls
**Структура листов:** "Товары" (основной лист для обработки)  
**Расположение данных:** данные начинаются с 5 строки  
**Наличие заголовков:** строка 3 содержит названия колонок  
**Название таблицы в БД** wb_products
**Особенности загрузки:** Файлы загружаются по несколько штук одновременно, все имеют одинаковую структуру и должны быть объединены в итоговой таблице
**Особенности данных:** Один товар может иметь несколько записей с одинаковыми артикулами, но разными размерами

## 2. Маппинг данных

| Поле Excel | Название в БД | Тип данных | Обязательность | Описание |
|------------|---------------|------------|----------------|----------|
| Группа | group_id | INTEGER | Необязательно | Идентификатор группы товара |
| Артикул продавца | wb_article | VARCHAR(100) | Обязательно | Артикул продавца (может повторяться для разных размеров) |
| Артикул WB | wb_sku | BIGINT | Обязательно | Идентификатор WB (может повторяться для разных размеров) |
| Наименование | product_name | VARCHAR(500) | Необязательно | Название товара |
| Категория продавца | seller_category | VARCHAR(200) | Необязательно | Категория товара у продавца |
| Бренд | brand | VARCHAR(100) | Необязательно | Бренд товара |
| Описание | description | TEXT | Необязательно | Описание товара |
| Фото | photos | TEXT | Необязательно | Ссылки на фото через ';' |
| Видео | video_url | VARCHAR(500) | Необязательно | Ссылка на видео |
| Пол | gender | VARCHAR(50) | Необязательно | Пол (Мальчики/Девочки/Унисекс) |
| Цвет | color | VARCHAR(100) | Необязательно | Цвет товара |
| Баркод | barcodes | TEXT | Необязательно | Список баркодов через ';' (первый - основной) |
| Размер | size | VARCHAR(20) | Необязательно | Размер товара |
| Рос. размер | russian_size | VARCHAR(20) | Необязательно | Российский размер |
| Вес с упаковкой | weight_kg | DECIMAL(8,3) | Необязательно | Вес в килограммах |
| Высота упаковки | package_height_cm | DECIMAL(8,2) | Необязательно | Высота в сантиметрах |
| Длина упаковки | package_length_cm | DECIMAL(8,2) | Необязательно | Длина в сантиметрах |
| Ширина упаковки | package_width_cm | DECIMAL(8,2) | Необязательно | Ширина в сантиметрах |
| ТНВЭД | tnved_code | VARCHAR(20) | Необязательно | Код товарной номенклатуры |
| Рейтинг | card_rating | DECIMAL(3,1) | Необязательно | Рейтинг заполненности характеристик |
| Ярлыки | labels | TEXT | Необязательно | Дополнительные ярлыки |
| Ставка НДС | vat_rate | VARCHAR(20) | Необязательно | Ставка НДС |

## 3. Правила валидации

### Форматы данных:
- **group_id**: Только положительные целые числа
- **wb_article**: Строка, может содержать буквы и цифры
- **wb_sku**: Только положительные целые числа
- **barcodes**: Список баркодов через ';'
- **weight_kg**: Положительное число, максимум 3 знака после запятой
- **package_*_cm**: Положительные числа, максимум 2 знака после запятой
- **card_rating**: Число от 0 до 10 с одним знаком после запятой

### Уникальность:
- **wb_sku + size**: комбинация должна быть уникальной (один товар с конкретным размером)
- **Основной баркод** (первый в списке): должен быть уникальным в рамках загрузки

### Обязательные поля:
- **wb_article** не могут быть пустыми
- Остальные поля необязательны, но рекомендуются для полноты данных

## 4. Обработка ошибок

### Дублирующиеся записи:
- Артикулы продавца и WB могут повторяться для разных размеров - это нормально
- Каждая загрузка нового отчета будет вести к дублированию записей, поэтому нужно перед новой записью очищать таблицу.

### Некорректные данные:
- Пропускать строки с некорректными обязательными полями
- Логировать все ошибки валидации с указанием строки и файла
- Продолжать обработку остальных строк

### Логирование:
- Обязательно логировать все ошибки валидации
- Вести статистику: обработано/пропущено/обновлено записей

### Стратегия:
- **Пропустить строку** при ошибке валидации
- Продолжить обработку файла
- В конце показать сводку по результатам импорта

## 5. Дополнительные требования

### Преобразования данных:
- **barcodes**: Разделить строку по ';' и сохранить как JSON массив, первый элемент - основной баркод (barcode_primary)
- **barcode_primary**: Извлечь первый баркод из списка как основной
- **photos**: Разделить строку по ';' и сохранить как JSON массив
- **brand**: Привести к единому регистру (первая буква заглавная)
- **color**: Привести к нижнему регистру

### Вычисляемые поля:
- **primary_barcode**: Актуальный баркод это первый в списке "barcodes"
- **package_volume_cm3**: Вычислить как height × length × width

### Производительность:
- **Пакетная загрузка**: по 1000 записей за раз
- **Индексы**: создать на wb_sku
- **Транзакции**: каждый файл обрабатывать в отдельной транзакции

### Интерфейс загрузки:
- Возможность выбора нескольких файлов одновременно
- Прогресс-бар для отображения процесса загрузки
- Детальный отчет по результатам импорта