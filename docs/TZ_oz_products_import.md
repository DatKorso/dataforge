# Техническое задание: Импорт данных продуктов Ozon

## 1. Описание источника данных

**Формат файла:** .csv
**Структура листов:** Один лист с данными продуктов
**Расположение данных:** Начиная с первой строки (заголовки в первой строке)
**Наличие заголовков:** Да, первая строка содержит названия колонок
**Разделитель:** Точка с запятой (;) или (,)
**Кодировка:** UTF-8
**Название таблицы в БД** oz_products

## 2. Маппинг данных

| Колонка CSV | Название в БД | Тип данных | Обязательность |
|-------------|---------------|------------|----------------|
| Артикул | oz_vendor_code | VARCHAR(100) | Обязательно |
| Ozon Product ID | oz_product_id | BIGINT | Обязательно |
| SKU | oz_sku | BIGINT | Обязательно |
| Barcode | barcode-primary | VARCHAR(50) | Необязательно |
| Название товара | product_name | TEXT | Обязательно |
| Бренд | brand | VARCHAR(100) | Необязательно |
| Статус товара | product_status | VARCHAR(50) | Необязательно |
| Метки | tags | TEXT | Необязательно |
| Отзывы | reviews_count | INTEGER | Необязательно |
| Рейтинг | rating | DECIMAL(3,2) | Необязательно |
| Видимость на Ozon | visibility_status | VARCHAR(50) | Необязательно |
| Причины скрытия | hide_reasons | TEXT | Необязательно |
| Доступно к продаже по схеме FBO, шт. | fbo_available | INTEGER | Необязательно |
| Зарезервировано, шт | reserved_qty | INTEGER | Необязательно |
| Текущая цена с учетом скидки, ₽ | current_price | DECIMAL(10,2) | Необязательно |
| Цена до скидки (перечеркнутая цена), ₽ | original_price | DECIMAL(10,2) | Необязательно |
| Цена Premium, ₽ | premium_price | DECIMAL(10,2) | Необязательно |
| Рыночная цена, ₽ | market_price | DECIMAL(10,2) | Необязательно |
| Размер НДС, % | vat_rate | VARCHAR(10) | Необязательно |

## 3. Правила валидации

### Форматы данных:
- **Артикул Ozon**: Не должен быть пустым, обязательная чистка от символа "'" в начале записи, максимум 100 символов
- **Ozon Product ID**: Не должен быть пустым
- **SKU**: Не должен быть пустым, максимум 50 символов
- **Рейтинг**: Число от 0.00 до 5.00
- **Цены**: Округлить до целых чисел
- **НДС**: Формат "XX%" где XX - число от 0 до 100

### Уникальность:
- **Ozon Product ID**: должен быть уникальным в рамках загрузки
- **SKU**: должен быть уникальным в рамках загрузки
- **Артикул Ozon**: должен быть уникальным в рамках загрузки

### Обязательные поля:
- Артикул Ozon
- Ozon Product ID
- SKU

## 4. Обработка ошибок

### Дублирующиеся записи:
- Каждая загрузка нового отчета будет вести к дублированию записей, поэтому нужно перед новой записью очищать таблицу.

### Некорректные данные:
- Пропускать строки с некорректными обязательными полями
- Для необязательных полей с ошибками - устанавливать NULL
- Логировать все ошибки валидации с указанием номера строки и типа ошибки

### Логирование ошибок:
- Создавать детальный лог импорта с указанием:
  - Общего количества обработанных строк
  - Количества успешно импортированных записей
  - Количества обновленных записей
  - Количества пропущенных строк с ошибками
  - Детального списка ошибок по строкам

### Стратегия обработки:
- **Продолжать обработку** при ошибках в отдельных строках
- **Остановить импорт** только при критических системных ошибках

## 5. Дополнительные требования

### Преобразования данных:
- **Цены**: Удалять символы валют и пробелы, преобразовывать в числовой формат
- **Проценты**: Удалять символ %, преобразовывать в числовой формат
- **Даты**: Преобразовывать в формат dd.mm.yyyy
- **Числовые поля**: Удалять апострофы и пробелы

### Вычисляемые поля:
- **discount_percent**: Процент скидки ((original_price - current_price) / original_price * 100)

### Производительность:
- **Индексы**: создать индексы по полям oz_product_id, sku, oz_vendor_code, barcode-primary

### Безопасность:
- Валидация на SQL-инъекции в текстовых полях
- Ограничение размера загружаемого файла (максимум 200MB)
- Проверка прав доступа пользователя на импорт данных
